From 9ea78e305a3c01837885fdc4b4eb1634e4817c92 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Gy=C3=B6rgy=20Kurucz?= <me@kuruczgy.com>
Date: Sun, 18 Aug 2024 23:51:42 +0200
Subject: [PATCH] devicetree hack

---
 nixos/modules/installer/cd-dvd/iso-image.nix | 43 +++++++++++---------
 1 file changed, 24 insertions(+), 19 deletions(-)

diff --git a/nixos/modules/installer/cd-dvd/iso-image.nix b/nixos/modules/installer/cd-dvd/iso-image.nix
index 06949bda1cb2..86555f4a51a2 100644
--- a/nixos/modules/installer/cd-dvd/iso-image.nix
+++ b/nixos/modules/installer/cd-dvd/iso-image.nix
@@ -16,25 +16,26 @@ let
    *  * option: {name, params, class}
    */
   menuBuilderGrub2 =
-  defaults: options: lib.concatStrings
-    (
-      map
-      (option: ''
-        menuentry '${defaults.name} ${
-        # Name appended to menuentry defaults to params if no specific name given.
-        option.name or (optionalString (option ? params) "(${option.params})")
-        }' ${optionalString (option ? class) " --class ${option.class}"} {
-          # Fallback to UEFI console for boot, efifb sometimes has difficulties.
-          terminal_output console
-
-          linux ${defaults.image} \''${isoboot} ${defaults.params} ${
-            option.params or ""
-          }
-          initrd ${defaults.initrd}
-        }
-      '')
-      options
-    )
+    defaults: options: lib.concatStrings
+      (
+        map
+          (option: ''
+            menuentry '${defaults.name} ${
+            # Name appended to menuentry defaults to params if no specific name given.
+            option.name or (optionalString (option ? params) "(${option.params})")
+            }' ${optionalString (option ? class) " --class ${option.class}"} {
+              # Fallback to UEFI console for boot, efifb sometimes has difficulties.
+              terminal_output console
+
+              devicetree /devicetree.dtb
+              linux ${defaults.image} \''${isoboot} ${defaults.params} ${
+                option.params or ""
+              }
+              initrd ${defaults.initrd}
+            }
+          '')
+          options
+      )
   ;
 
   /**
@@ -821,6 +822,10 @@ in
         { source = config.system.build.initialRamdisk + "/" + config.system.boot.loader.initrdFile;
           target = "/boot/" + config.system.boot.loader.initrdFile;
         }
+        {
+          source = "${config.hardware.deviceTree.package}/${config.hardware.deviceTree.name}";
+          target = "/devicetree.dtb";
+        }
         { source = pkgs.writeText "version" config.system.nixos.label;
           target = "/version.txt";
         }
-- 
2.44.1

